# Agent Orchestrator — NEW-OS Multi-Agent System
# Fork: dmochalinn/agent-orchestrator (upstream: ComposioHQ/agent-orchestrator)

dataDir: ~/.agent-orchestrator
worktreeDir: ~/.worktrees
port: 3000
terminalPort: 14800
directTerminalPort: 14801

defaults:
  runtime: tmux
  agent: claude-code
  workspace: worktree
  notifiers: []

projects:
  agent-orchestrator:
    name: Agent Orchestrator
    repo: dmochalinn/agent-orchestrator
    path: /root/agent-orchestrator
    defaultBranch: main
    sessionPrefix: orc
    symlinks: [.claude]
    scm:
      plugin: github
    tracker:
      plugin: github
    agentConfig:
      permissions: skip
      model: claude-sonnet-4-6
    orchestratorRules: |
      ## NEW-OS Orchestration Rules
      Central task board: dmochalinn/new-os-tasks (GitHub Issues).

      ### DEDUP CHECK (ОБЯЗАТЕЛЬНО перед созданием любого Issue)
      Перед созданием ЛЮБОГО issue в new-os-tasks выполни:
        existing=$(gh issue list -R dmochalinn/new-os-tasks --state all --limit 100           --json number,title | jq -r '.[] | "\(.number) \(.title)"')
      Если похожий заголовок уже существует — НЕ СОЗДАВАТЬ дубликат.
      Вместо этого: прокомментировать существующий issue или пропустить.

      ### Workflow
      1. LIST ready: gh issue list -R dmochalinn/new-os-tasks -l ready --json number,title,labels,body,url
      2. PICK: p0 first, then p1, then by creation date
      3. ROUTE by label:
           target/den-workspace  -> ao spawn den-workspace <url>
           target/den-mini-app   -> ao spawn den-mini-app <url>
           target/orc            -> ao spawn agent-orchestrator <url>
      4. SPAWN max 2 concurrent sessions
      5. MONITOR: ao status
      6. ON approved-and-green -> auto-merge
      7. ON ci-failed -> send-to-agent with error context
      8. REPEAT until no ready issues remain

      ### ЗАПРЕЩЕНО
      - Создавать issue если аналогичный уже есть (любое состояние: open/closed)
      - Спаунить сессию без issue URL из new-os-tasks
    reactions:
      ci-failed:
        auto: true
        action: send-to-agent
        message: "CI failed. Check: gh pr checks, fix, push."
        retries: 3
        escalateAfter: "45m"
      changes-requested:
        auto: true
        action: send-to-agent
        message: "Review comments posted. Address each one and push."
        escalateAfter: "30m"
      approved-and-green:
        auto: true
        action: auto-merge
        priority: action

  den-workspace:
    name: DEN Workspace
    repo: dmochalinn/den-workspace
    path: /root/clawd-den
    defaultBranch: main
    sessionPrefix: vault
    symlinks: [.claude]
    tracker:
      plugin: github
    scm:
      plugin: github
    agentConfig:
      permissions: skip
      model: claude-sonnet-4-6
    agentRules: |
      Always run tests before pushing.
      Use conventional commits (feat:, fix:, chore:, docs:).
      Link issue number in commit message.
      NEVER hardcode secrets or commit .env files.
      For target/vps-direct issues: you are ON the VPS, run commands directly.
      NEVER create new GitHub Issues in dmochalinn/new-os-tasks.
         Sub-tasks -> document as comments on current issue or in PR description.
    reactions:
      ci-failed:
        auto: true
        action: send-to-agent
        message: "CI failing. Run gh pr checks, fix, push."
        retries: 3
        escalateAfter: "45m"
      changes-requested:
        auto: true
        action: send-to-agent
        message: "Review comments. Address each, push fixes."
        escalateAfter: "30m"
      approved-and-green:
        auto: true
        action: auto-merge
        priority: action

  den-mini-app:
    name: DEN Mini-App
    repo: dmochalinn/den-mini-app
    path: /root/den-mini-app
    defaultBranch: main
    sessionPrefix: app
    symlinks: [.claude]
    postCreate:
      - "npm ci"
    tracker:
      plugin: github
    scm:
      plugin: github
    agentConfig:
      permissions: skip
      model: claude-sonnet-4-6
    agentRules: |
      Always run: npm run typecheck && npm run lint before pushing.
      Use conventional commits.
      ALL API endpoints MUST use requireAuth middleware.
      NEVER expose secrets in responses.
      NEVER create new GitHub Issues in dmochalinn/new-os-tasks.
         Sub-tasks -> document as comments on current issue or in PR description.
    reactions:
      ci-failed:
        auto: true
        action: send-to-agent
        message: "CI failed. Run: npm run typecheck && npm run lint && npm test"
        retries: 3
        escalateAfter: "30m"
      changes-requested:
        auto: true
        action: send-to-agent
        escalateAfter: "30m"
      approved-and-green:
        auto: true
        action: auto-merge
        priority: action
